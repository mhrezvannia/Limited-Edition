{% extends 'base.html' %}
{% load static %}
{% csrf_token %}

{% block content %}
<section class="shop-cart spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="shop__cart__table">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cart-body">
                            <!-- Products will be dynamically loaded here via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-6">
                <div class="cart__btn">
                    <a href="{% url 'website:product_list' %}">Continue Shopping</a>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="discount__content">
                    <h6>Discount codes</h6>
                    <form action="#">
                        <input type="text" placeholder="Enter your coupon code">
                        <button type="submit" class="site-btn">Apply</button>
                    </form>
                </div>
            </div>
            <div class="col-lg-4 offset-lg-2">
                <div class="cart__total__procced">
                    <h6>Cart total</h6>
                    <ul>
                        <li>Subtotal <span id="cart-subtotal">$0.0</span></li>
                        <li>Total <span id="cart-total">$0.0</span></li>
                    </ul>
                    <a href="{% url 'orders:check_out' %}" class="primary-btn">Proceed to checkout</a>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    // Fetch cart data using the ViewCartAPIView
    function loadCart() {
        fetch('/orders/api/v1/cart/view/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(data => {
            const cartBody = document.getElementById('cart-body');
            cartBody.innerHTML = ''; // Clear the existing cart

            let subtotal = 0;
            data.forEach(item => {
                const productTotal = item.quantity * parseFloat(item.product_price);
                subtotal += productTotal;

                cartBody.innerHTML += `
                    <tr data-product-id="${item.product_id}">
                        <td class="cart__product__item">
                            <img src="${item.product_image}" alt="${item.product_title}" width="100">
                            <div class="cart__product__item__title">
                                <h6>${item.product_title}</h6>
                            </div>
                        </td>
                        <td class="cart__price">$ ${parseFloat(item.product_price).toFixed(2)}</td>
                        <td class="cart__quantity">
                            <div class="pro-qty">
                                <input type="number" min="1" value="${item.quantity}" onchange="updateQuantity(${item.product_id}, this.value)">
                            </div>
                        </td>
                        <td class="cart__total" id="total-${item.product_id}">$ ${productTotal.toFixed(2)}</td>
                        <td class="cart__close">
                            <span class="icon_close" onclick="deleteCartItem(${item.product_id})"></span>
                        </td>
                    </tr>
                `;
            });

            // Update cart subtotal and total
            document.getElementById('cart-subtotal').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('cart-total').innerText = `$${subtotal.toFixed(2)}`;
        })
        .catch(error => {
            console.error('Error fetching cart:', error);
        });
    }

    // Delete item from cart
    function deleteCartItem(productId) {
        fetch(`/orders/api/v1/cart/remove/${productId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => {
            if (response.ok) {
                loadCart(); // Reload cart after deletion
            } else {
                console.error('Failed to delete item');
            }
        })
        .catch(error => {
            console.error('Error deleting cart item:', error);
        });
    }

    // Update quantity of an item in the cart
    function updateQuantity(productId, newQuantity) {
        if (newQuantity <= 0) {
            alert('Quantity must be at least 1');
            return;
        }

        fetch(`/orders/api/v1/cart/update/${productId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                quantity: newQuantity
            })
        })
        .then(response => {
            if (response.ok) {
                // Update the cart display after successful update
                const pricePerUnit = parseFloat(document.querySelector(`tr[data-product-id="${productId}"] .cart__price`).innerText.replace('$', ''));
                const totalCell = document.getElementById(`total-${productId}`);
                const productTotal = pricePerUnit * newQuantity;
                totalCell.innerText = `$${productTotal.toFixed(2)}`;

                // Recalculate the subtotal and total for the cart
                recalculateCartTotal();
            } else {
                console.error('Failed to update quantity');
            }
        })
        .catch(error => {
            console.error('Error updating cart quantity:', error);
        });
    }

    // Recalculate the total of the cart
    function recalculateCartTotal() {
        const cartItems = document.querySelectorAll('#cart-body tr');
        let subtotal = 0;

        cartItems.forEach(item => {
            const totalPrice = parseFloat(item.querySelector('.cart__total').innerText.replace('$', ''));
            subtotal += totalPrice;
        });

        document.getElementById('cart-subtotal').innerText = `$${subtotal.toFixed(2)}`;
        document.getElementById('cart-total').innerText = `$${subtotal.toFixed(2)}`;
    }


    window.onload = loadCart;
</script>

{% endblock %}
